<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf GPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-providers@2.0.2/leaflet-providers.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
        }
        .icon {
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        #wake-lock-icon {
            stroke-width: 3;
        }
        #scorecard-btn .scorecard-icon path {
            fill: currentColor;
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 1.5rem;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-zinc-50 dark:bg-zinc-900 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white dark:bg-zinc-800 rounded-3xl shadow-2xl p-8 max-w-sm w-full mx-auto min-h-[80vh] flex flex-col justify-between transition-colors">

        <div id="setup-view" class="flex flex-col justify-center h-full space-y-8">
            <h1 class="text-4xl font-extrabold text-center text-zinc-900 dark:text-zinc-100">Round Setup</h1>
            <p id="mode-select-text" class="text-center text-zinc-600 dark:text-zinc-300 font-semibold text-lg">Choose your mode:</p>
            
            <div id="mode-buttons" class="flex flex-col space-y-4">
                <button id="mode-scorecard-btn" class="w-full bg-blue-600 text-white font-bold py-5 px-4 rounded-3xl shadow-xl hover:bg-blue-700 transition-colors transform hover:scale-105 text-2xl">
                    Scorecard & GPS
                </button>
                
                <button id="mode-gps-only-btn" class="w-full bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 font-bold py-5 px-4 rounded-3xl shadow-xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors text-2xl">
                    GPS Only
                </button>
            </div>

            <div id="player-setup-options" class="hidden flex flex-col items-center">
                <label for="player-count" class="block text-center text-zinc-600 dark:text-zinc-300 font-semibold mb-2">Select Number of Players</label>
                <div class="flex justify-center space-x-2 mb-8">
                    <button class="player-count-btn p-4 rounded-xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-lg hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-count="1">1</button>
                    <button class="player-count-btn p-4 rounded-xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-lg hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-count="2">2</button>
                    <button class="player-count-btn p-4 rounded-xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-lg hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-count="3">3</button>
                    <button class="player-count-btn p-4 rounded-xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-lg hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-count="4">4</button>
                </div>
                <div id="player-name-inputs" class="mb-8 hidden">
                    <label class="block text-center text-zinc-600 dark:text-zinc-300 font-semibold mb-2">Enter Player Names</label>
                </div>
                <button id="start-scorecard-round-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors transform hover:scale-105">Start Round</button>
            </div>
        </div>

        <div id="main-view" class="hidden flex-col justify-between h-full">
            <div class="flex justify-between items-center mb-6">
                <button id="scorecard-btn" class="flex flex-col items-center p-2 rounded-full text-zinc-800 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-700 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">
                    <svg class="scorecard-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 8 9 8 11"></polyline>
                    </svg>
                    <span class="text-xs mt-1 font-semibold">Scorecard</span>
                </button>
                
                <div class="text-center flex-grow">
                    <h1 id="course-name" class="text-2xl font-extrabold text-zinc-900 dark:text-zinc-100 mb-1 transition-colors"></h1>
                    <p id="hole-info" class="text-md text-zinc-500 dark:text-zinc-400 font-medium transition-colors"></p>
                </div>
                
                <button id="wake-lock-btn" class="flex flex-col items-center p-2 rounded-full text-zinc-800 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-700 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">
                    <svg id="wake-lock-icon" class="w-6 h-6 icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span id="wake-lock-text" class="text-xs mt-1 font-semibold">Keep Screen On</span>
                </button>
            </div>

            <div class="flex-grow flex flex-col justify-center">
                <div class="grid grid-cols-3 gap-4 text-center mb-6">
                    <div class="bg-teal-100 dark:bg-teal-900 rounded-2xl p-4 shadow-inner transition-colors">
                        <p class="text-sm font-semibold text-zinc-600 dark:text-zinc-300">Front</p>
                        <p id="distance-front" class="text-4xl font-black text-red-600 dark:text-red-400 mt-2">--</p>
                        <p class="text-xs text-zinc-400 dark:text-zinc-500">yards</p>
                    </div>
                    <div class="bg-teal-100 dark:bg-teal-900 rounded-2xl p-4 shadow-inner transition-colors">
                        <p class="text-sm font-semibold text-zinc-600 dark:text-zinc-300">Center</p>
                        <p id="distance-center" class="text-4xl font-black text-white dark:text-white mt-2">--</p>
                        <p class="text-xs text-zinc-400 dark:text-zinc-500">yards</p>
                    </div>
                    <div class="bg-teal-100 dark:bg-teal-900 rounded-2xl p-4 shadow-inner transition-colors">
                        <p class="text-sm font-semibold text-zinc-600 dark:text-zinc-300">Back</p>
                        <p id="distance-back" class="text-4xl font-black text-red-600 dark:text-red-400 mt-2">--</p>
                        <p class="text-xs text-zinc-400 dark:text-zinc-500">yards</p>
                    </div>
                </div>
                
                <div class="flex-grow mb-6">
                    <div id="map" class="w-full h-full rounded-2xl shadow-inner"></div>
                </div>

                <div class="flex justify-between space-x-4">
                    <button id="prev-hole-btn" class="flex-1 bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 font-bold py-3 px-4 rounded-full shadow-lg hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">Previous Hole</button>
                    <button id="next-hole-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors">Next Hole</button>
                </div>
            </div>
            
            <button id="end-round-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-red-700 transition-colors mt-6">End Round</button>
        </div>
        
        <div id="scorecard-view" class="hidden flex-col justify-between h-full">
            <div class="flex justify-between items-center mb-6">
                <button id="map-btn" class="flex flex-col items-center p-2 rounded-full text-zinc-800 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-700 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">
                    <svg class="w-6 h-6 icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                        <line x1="8" y1="2" x2="8" y2="18"></line>
                        <line x1="16" y1="6" x2="16" y2="22"></line>
                    </svg>
                    <span class="text-xs mt-1 font-semibold">Map</span>
                </button>
                <h1 class="text-2xl font-extrabold text-center text-zinc-900 dark:text-zinc-100">Scorecard</h1>
                <button id="scorecard-end-round-btn" class="flex flex-col items-center p-2 rounded-full text-zinc-800 dark:text-zinc-200 bg-red-200 dark:bg-red-700 hover:bg-red-300 dark:hover:bg-red-600 transition-colors">
                    <svg class="w-6 h-6 icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    <span class="text-xs mt-1 font-semibold">End</span>
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto mb-6">
                <table class="w-full text-center border-collapse table-fixed">
                    <thead>
                        <tr class="bg-zinc-100 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 font-bold sticky top-0 shadow">
                            <th class="p-2 border border-zinc-200 dark:border-zinc-600 w-[15%]">Hole</th>
                            <th class="p-2 border border-zinc-200 dark:border-zinc-600 w-[25%]">Par</th>
                            <th class="p-2 border border-zinc-200 dark:border-zinc-600 w-[60%]" colspan="4" id="player-headers"></th>
                        </tr>
                    </thead>
                    <tbody id="scorecard-body" class="text-zinc-900 dark:text-zinc-100"></tbody>
                </table>
            </div>

            <div id="scorecard-totals" class="grid w-full text-center font-bold mb-4"></div>
        </div>

        <div id="score-entry-view" class="hidden flex-col justify-center h-full text-center">
            <h2 class="text-2xl font-bold text-zinc-900 dark:text-zinc-100 mb-4" id="score-entry-title">Hole --</h2>
            <p id="score-entry-message" class="text-md text-zinc-600 dark:text-zinc-300 mb-6"></p>
            
            <div id="score-buttons" class="grid grid-cols-3 gap-4 mb-8">
                <button class="score-btn p-4 rounded-2xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-2xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-score="-2">Eagle</button>
                <button class="score-btn p-4 rounded-2xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-2xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-score="-1">Birdie</button>
                <button class="score-btn p-4 rounded-2xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-2xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-score="0">Par</button>
                <button class="score-btn p-4 rounded-2xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-2xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-score="1">Bogey</button>
                <button class="score-btn p-4 rounded-2xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-2xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-score="2">Double</button>
                <button class="score-btn p-4 rounded-2xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-2xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-score="3">Triple</button>
                <button class="score-btn p-4 rounded-2xl bg-zinc-200 dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 font-bold text-2xl hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" data-score="4">4+</button>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button id="score-back-btn" class="bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 font-bold py-3 px-4 rounded-full shadow-lg hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors">Back</button>
                <button id="score-next-btn" class="bg-blue-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors">Next</button>
            </div>
        </div>

    </div>

    <script>
        (function() {
            const apiKey = 'YOUR_GOOGLE_MAPS_API_KEY';
            const courseData = {
                name: "HadleyCreek",
                holes: [
                    { hole: 1, par: 3, tee: [44.075384, -92.431759], front: [44.074584, -92.432029], center: [44.074452, -92.432007], back: [44.074334, -92.431968], hazards: [] },
                    { hole: 2, par: 4, tee: [44.073303, -92.431259], front: [44.074169, -92.434047], center: [44.074227, -92.434211], back: [44.074301, -92.434349], hazards: [{ name: "Right Bunker", location: [44.073809, -92.432729] }, { name: "Left Bunker", location: [44.073771, -92.433538] }] },
                    { hole: 3, par: 3, tee: [44.073554, -92.434544], front: [44.072758, -92.433836], center: [44.072678, -92.433714], back: [44.072582, -92.433597], hazards: [{ name: "Left Bunker", location: [44.07296298584522, -92.43384416400436] }] },
                    { hole: 4, par: 3, tee: [44.072748, -92.434836], front: [44.073577, -92.435656], center: [44.073693, -92.435775], back: [44.073808, -92.435914], hazards: [] },
                    { hole: 5, par: 4, tee: [44.074034, -92.439247], front: [44.074087, -92.442439], center: [44.074133, -92.442610], back: [44.074181, -92.442764], hazards: [] },
                    { hole: 6, par: 3, tee: [44.073704, -92.443746], front: [44.073768, -92.444650], center: [44.073819, -92.444810], back: [44.073841, -92.444974], hazards: [{ name: "Water on Right", location: [44.07385845583365, -92.44452525640412] }] },
                    { hole: 7, par: 4, tee: [44.075151, -92.445116], front: [44.074793, -92.441756], center: [44.074769, -92.441583], back: [44.074780, -92.441421], hazards: [{ name: "Left Bunker", location: [44.074621, -92.442656] }, { name: "Right Water", location: [44.074800, -92.441900] }] },
                    { hole: 8, par: 3, tee: [44.07491196732004, -92.43994731525015], front: [44.074910, -92.438149], center: [44.074950, -92.437983], back: [44.074989, -92.437890], hazards: [] },
                    { hole: 9, par: 4, tee: [44.074869, -92.436735], front: [44.075048, -92.433139], center: [44.075108, -92.433005], back: [44.075154, -92.432855], hazards: [{ name: "Left Bunker", location: [44.07517764620998, -92.43392076595802] }] }
                ]
            };
            const state = {
                mode: null,
                players: [],
                currentHoleIndex: 0,
                isEditingScore: false,
                currentPlayerIndex: 0,
                wakeLock: null,
                map: null,
                userMarker: null,
                courseMarkers: [],
            };

            const elements = {
                setupView: document.getElementById('setup-view'),
                mainView: document.getElementById('main-view'),
                scorecardView: document.getElementById('scorecard-view'),
                scoreEntryView: document.getElementById('score-entry-view'),
                modeScorecardBtn: document.getElementById('mode-scorecard-btn'),
                modeGpsOnlyBtn: document.getElementById('mode-gps-only-btn'),
                playerSetupOptions: document.getElementById('player-setup-options'),
                playerCountBtns: document.querySelectorAll('.player-count-btn'),
                playerNameInputs: document.getElementById('player-name-inputs'),
                startScorecardRoundBtn: document.getElementById('start-scorecard-round-btn'),
                courseName: document.getElementById('course-name'),
                holeInfo: document.getElementById('hole-info'),
                distanceFront: document.getElementById('distance-front'),
                distanceCenter: document.getElementById('distance-center'),
                distanceBack: document.getElementById('distance-back'),
                mapBtn: document.getElementById('map-btn'),
                scorecardBtn: document.getElementById('scorecard-btn'),
                prevHoleBtn: document.getElementById('prev-hole-btn'),
                nextHoleBtn: document.getElementById('next-hole-btn'),
                endRoundBtn: document.getElementById('end-round-btn'),
                scorecardEndRoundBtn: document.getElementById('scorecard-end-round-btn'),
                scorecardBody: document.getElementById('scorecard-body'),
                scorecardTotals: document.getElementById('scorecard-totals'),
                playerHeaders: document.getElementById('player-headers'),
                scoreEntryTitle: document.getElementById('score-entry-title'),
                scoreEntryMessage: document.getElementById('score-entry-message'),
                scoreButtons: document.querySelectorAll('.score-btn'),
                scoreBackBtn: document.getElementById('score-back-btn'),
                scoreNextBtn: document.getElementById('score-next-btn'),
                wakeLockBtn: document.getElementById('wake-lock-btn'),
                wakeLockIcon: document.getElementById('wake-lock-icon'),
                wakeLockText: document.getElementById('wake-lock-text'),
                modeButtons: document.getElementById('mode-buttons'),
            };

            function toggleWakeLock() {
                if ('wakeLock' in navigator) {
                    if (state.wakeLock !== null) {
                        try {
                            state.wakeLock.release().then(() => {
                                state.wakeLock = null;
                                elements.wakeLockIcon.classList.remove('text-blue-500');
                                elements.wakeLockIcon.classList.add('text-zinc-800', 'dark:text-zinc-200');
                                elements.wakeLockText.textContent = 'Keep Screen On';
                                console.log('Wake lock released.');
                            });
                        } catch (err) {
                            console.error(`${err.name}, ${err.message}`);
                        }
                    } else {
                        try {
                            navigator.wakeLock.request('screen').then(lock => {
                                state.wakeLock = lock;
                                state.wakeLock.addEventListener('release', () => {
                                    console.log('Wake lock was released by the OS.');
                                    state.wakeLock = null;
                                    elements.wakeLockIcon.classList.remove('text-blue-500');
                                    elements.wakeLockIcon.classList.add('text-zinc-800', 'dark:text-zinc-200');
                                    elements.wakeLockText.textContent = 'Keep Screen On';
                                });
                                elements.wakeLockIcon.classList.remove('text-zinc-800', 'dark:text-zinc-200');
                                elements.wakeLockIcon.classList.add('text-blue-500');
                                elements.wakeLockText.textContent = 'Screen On';
                                console.log('Wake lock activated.');
                            });
                        } catch (err) {
                            console.error(`${err.name}, ${err.message}`);
                        }
                    }
                } else {
                    console.log('Wake Lock API not supported.');
                }
            }

            elements.wakeLockBtn.addEventListener('click', toggleWakeLock);

            function showView(viewId) {
                const views = ['setup-view', 'main-view', 'scorecard-view', 'score-entry-view'];
                views.forEach(id => {
                    document.getElementById(id).classList.add('hidden', 'flex-col');
                    document.getElementById(id).classList.remove('flex');
                });
                document.getElementById(viewId).classList.remove('hidden');
                document.getElementById(viewId).classList.add('flex');
            }

            function initMap() {
                if (state.map) {
                    state.map.remove();
                }
                state.map = L.map('map').setView(courseData.holes[0].center, 17);
                L.tileLayer.provider('Esri.WorldImagery').addTo(state.map);
            }

            function showMap() {
                if (!state.map) {
                    initMap();
                }
                showView('main-view');
                setTimeout(() => {
                    state.map.invalidateSize();
                    updateMapMarkers();
                }, 0);
                updateDistances();
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(updateUserPosition, handleError, { enableHighAccuracy: true });
                }
            }

            function updateMapMarkers() {
                if (!state.map) return;
                state.courseMarkers.forEach(marker => state.map.removeLayer(marker));
                state.courseMarkers = [];

                const currentHole = courseData.holes[state.currentHoleIndex];
                const markerOptions = {
                    icon: L.divIcon({
                        className: 'map-marker-icon',
                        html: `<div class="bg-blue-600 text-white font-bold p-2 rounded-full shadow-lg text-sm">Hole ${currentHole.hole}</div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    })
                };
                const marker = L.marker(currentHole.center, markerOptions).addTo(state.map);
                state.courseMarkers.push(marker);

                state.map.setView(currentHole.center, 17);
            }

            function updateUserPosition(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const userLatLng = L.latLng(lat, lng);
                
                if (state.userMarker) {
                    state.userMarker.setLatLng(userLatLng);
                } else {
                    state.userMarker = L.marker(userLatLng).addTo(state.map);
                }
                
                updateDistances(userLatLng);
            }

            function updateDistances(userLatLng) {
                const currentHole = courseData.holes[state.currentHoleIndex];
                const holeLatLng = L.latLng(currentHole.center);
                
                let frontDistance = '--';
                let centerDistance = '--';
                let backDistance = '--';

                if (userLatLng) {
                    const distanceMeters = userLatLng.distanceTo(holeLatLng);
                    const distanceYards = (distanceMeters * 1.09361).toFixed(0);
                    
                    const heading = L.CRS.Earth.bearing(holeLatLng, userLatLng);
                    const frontPoint = L.CRS.Earth.destination(holeLatLng, heading, distanceMeters - 10);
                    const backPoint = L.CRS.Earth.destination(holeLatLng, heading, distanceMeters + 10);
                    
                    frontDistance = userLatLng.distanceTo(L.latLng(currentHole.front)).toFixed(0);
                    centerDistance = userLatLng.distanceTo(L.latLng(currentHole.center)).toFixed(0);
                    backDistance = userLatLng.distanceTo(L.latLng(currentHole.back)).toFixed(0);
                }

                elements.distanceFront.textContent = frontDistance;
                elements.distanceCenter.textContent = centerDistance;
                elements.distanceBack.textContent = backDistance;
            }

            function handleError(error) {
                console.error("Geolocation error: " + error.message);
            }

            elements.modeScorecardBtn.addEventListener('click', () => {
                state.mode = "scorecard";
                elements.modeButtons.classList.add('hidden');
                elements.playerSetupOptions.classList.remove('hidden');
            });

            elements.modeGpsOnlyBtn.addEventListener('click', () => {
                state.mode = "gps";
                startRound();
            });
            
            elements.playerCountBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const playerCount = parseInt(btn.dataset.count);
                    elements.playerNameInputs.innerHTML = '';
                    state.players = [];
                    for (let i = 0; i < playerCount; i++) {
                        state.players.push({ name: `Player ${i + 1}`, scores: [] });
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.placeholder = `Player ${i + 1} Name`;
                        input.classList.add('w-full', 'p-3', 'mb-2', 'rounded-xl', 'bg-zinc-100', 'dark:bg-zinc-700', 'text-center', 'font-medium', 'text-zinc-900', 'dark:text-zinc-100', 'placeholder-zinc-400', 'dark:placeholder-zinc-500', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');
                        input.dataset.index = i;
                        input.addEventListener('input', (e) => {
                            state.players[e.target.dataset.index].name = e.target.value || `Player ${parseInt(e.target.dataset.index) + 1}`;
                        });
                        elements.playerNameInputs.appendChild(input);
                    }
                    elements.playerNameInputs.classList.remove('hidden');
                    document.querySelectorAll('.player-count-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
                    btn.classList.add('bg-blue-500', 'text-white');
                });
            });

            elements.startScorecardRoundBtn.addEventListener('click', startRound);

            elements.nextHoleBtn.addEventListener('click', () => changeHole(1));
            elements.prevHoleBtn.addEventListener('click', () => changeHole(-1));
            
            elements.endRoundBtn.addEventListener('click', endRound);
            elements.scorecardEndRoundBtn.addEventListener('click', endRound);
            
            elements.mapBtn.addEventListener('click', showMap);
            elements.scorecardBtn.addEventListener('click', showScorecard);

            elements.scoreButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const scoreDiff = parseInt(btn.dataset.score);
                    const par = courseData.holes[state.currentHoleIndex].par;
                    const score = par + scoreDiff;
                    const playerIndex = state.currentPlayerIndex;
                    state.players[playerIndex].scores[state.currentHoleIndex] = score;
                    generateScorecard();
                    showScorecard();
                });
            });

            elements.scoreNextBtn.addEventListener('click', () => {
                let nextPlayerIndex = state.currentPlayerIndex + 1;
                let nextHoleIndex = state.currentHoleIndex;
                if (nextPlayerIndex >= state.players.length) {
                    nextPlayerIndex = 0;
                    nextHoleIndex = state.currentHoleIndex + 1;
                }

                if (nextHoleIndex >= courseData.holes.length) {
                    showScorecard();
                } else {
                    state.isEditingScore = false;
                    state.currentPlayerIndex = nextPlayerIndex;
                    state.currentHoleIndex = nextHoleIndex;
                    showScoreEntry(courseData.holes[state.currentHoleIndex].hole);
                }
            });

            elements.scoreBackBtn.addEventListener('click', () => showScorecard());

            function startRound() {
                showView('main-view');
                elements.courseName.textContent = courseData.name;
                state.currentHoleIndex = 0;
                updateHoleInfo();
                if (state.mode === "scorecard") {
                    state.players.forEach(player => player.scores = new Array(courseData.holes.length).fill(null));
                    elements.scorecardBtn.classList.remove('hidden');
                    elements.scorecardEndRoundBtn.classList.remove('hidden');
                    elements.endRoundBtn.classList.add('hidden');
                } else {
                    elements.scorecardBtn.classList.add('hidden');
                    elements.scorecardEndRoundBtn.classList.add('hidden');
                    elements.endRoundBtn.classList.remove('hidden');
                }
                initMap();
            }

            function endRound() {
                if (confirm("Are you sure you want to end the round?")) {
                    showView('setup-view');
                    state.mode = null;
                    state.players = [];
                    state.currentHoleIndex = 0;
                    state.isEditingScore = false;
                    state.currentPlayerIndex = 0;
                    elements.modeButtons.classList.remove('hidden');
                    elements.playerSetupOptions.classList.add('hidden');
                    elements.playerNameInputs.classList.add('hidden');
                    document.querySelectorAll('.player-count-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
                }
            }

            function changeHole(direction) {
                let newIndex = state.currentHoleIndex + direction;
                if (newIndex >= 0 && newIndex < courseData.holes.length) {
                    state.currentHoleIndex = newIndex;
                    updateHoleInfo();
                    updateMapMarkers();
                }
            }

            function updateHoleInfo() {
                const currentHole = courseData.holes[state.currentHoleIndex];
                elements.holeInfo.textContent = `Hole ${currentHole.hole} - Par ${currentHole.par}`;
            }

            function showScorecard() {
                showView('scorecard-view');
                if (state.mode === "scorecard") {
                    generateScorecard();
                }
            }

            function showScoreEntry(holeNumber) {
                showView('score-entry-view');
                elements.scoreEntryTitle.textContent = `Hole ${holeNumber}`;
                elements.scoreEntryMessage.textContent = `Enter score for ${state.players[state.currentPlayerIndex].name}:`;
            }

            function generateScorecard() {
                let playerHeaders = ``;
                state.players.forEach(player => {
                    playerHeaders += `<th class="p-2 border border-zinc-200 dark:border-zinc-600">${player.name.split(' ')[0]}</th>`;
                });
                elements.playerHeaders.innerHTML = playerHeaders;
                elements.playerHeaders.colSpan = state.players.length;
                
                let scorecardHtml = '';
                let totals = new Array(state.players.length).fill(0);
                let strokes = new Array(state.players.length).fill(0);

                courseData.holes.forEach((hole, holeIndex) => {
                    let rowHtml = `<tr class="border-b border-zinc-200 dark:border-zinc-700 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors cursor-pointer">
                                    <td class="p-2 border border-zinc-200 dark:border-zinc-600 text-sm font-semibold">${hole.hole}</td>
                                    <td class="p-2 border border-zinc-200 dark:border-zinc-600 text-sm font-semibold">${hole.par}</td>`;
                    
                    state.players.forEach((player, playerIndex) => {
                        const score = player.scores[holeIndex];
                        let scoreHtml = '--';
                        let scoreClass = '';
                        if (score !== null) {
                            scoreHtml = score;
                            strokes[playerIndex] += score;
                            const diff = score - hole.par;
                            totals[playerIndex] += diff;
                            scoreClass = getScoreClass(score, hole.par);
                        }
                        rowHtml += `<td class="p-2 border border-zinc-200 dark:border-zinc-600 font-bold ${scoreClass}" onclick="editScore(${holeIndex}, ${playerIndex})">${scoreHtml}</td>`;
                    });
                    scorecardHtml += rowHtml + '</tr>';
                });

                elements.scorecardBody.innerHTML = scorecardHtml;

                let scorecardTotalsHtml = `
                    <div class="bg-zinc-100 dark:bg-zinc-700 rounded-bl-2xl p-4 text-center">
                        <p class="font-bold text-lg text-zinc-800 dark:text-zinc-200">Totals</p>
                    </div>
                    ${state.players.map((player, playerIndex) => {
                        const totalClass = totals[playerIndex] > 0 ? 'text-red-500 dark:text-red-400' : 'text-green-500 dark:text-green-400';
                        const sign = totals[playerIndex] > 0 ? '+' : '';
                        return `
                        <div class="bg-zinc-100 dark:bg-zinc-700 p-4 text-center ${playerIndex === state.players.length - 1 ? 'rounded-br-2xl' : ''}">
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-zinc-500 dark:text-zinc-400 font-semibold">${strokes[playerIndex]}</span>
                                <span class="text-sm font-semibold ${totalClass}">${sign}${totals[playerIndex]}</span>
                            </div>
                        </div>`;
                    }).join('')}
                `;

                elements.scorecardTotals.innerHTML = scorecardTotalsHtml;
                elements.scorecardTotals.style.gridTemplateColumns = `repeat(${state.players.length + 1}, minmax(0, 1fr))`;
            }

            function editScore(holeIndex, playerIndex) {
                state.isEditingScore = true;
                state.currentHoleIndex = holeIndex;
                state.currentPlayerIndex = playerIndex;
                showScoreEntry(courseData.holes[state.currentHoleIndex].hole);
                elements.scoreEntryMessage.textContent = `Editing score for ${state.players[playerIndex].name} on Hole ${courseData.holes[holeIndex].hole}.`;
            }

            function getScoreClass(score, par) {
                const diff = score - par;
                if (diff <= -2) return 'text-violet-500 font-extrabold';
                if (diff === -1) return 'text-green-500 font-extrabold';
                if (diff === 0) return 'text-blue-500 font-extrabold';
                if (diff === 1) return 'text-orange-500 font-extrabold';
                if (diff >= 2) return 'text-red-500 font-extrabold';
                return '';
            }

            window.editScore = editScore;
        })();
    </script>
</body>
</html>
